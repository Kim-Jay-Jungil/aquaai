<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>업로드 — aqua.ai</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<header class="header">
  <div class="container nav">
    <div class="logo">aqua.ai</div>
    <nav>
      <a href="/">Home</a>
      <a href="/signin">로그인</a>
    </nav>
  </div>
</header>

<section class="section">
  <div class="container">
    <h1 class="h1">업로드</h1>
    <div class="card" style="padding:18px">
      <input id="file" type="file" accept="image/*"/>
      <div style="display:flex; gap:10px; margin-top:12px">
        <button id="btn" class="btn primary">업로드</button>
        <a id="link" class="btn ghost" target="_blank" style="display:none">링크 열기</a>
      </div>
      <progress id="bar" value="0" max="100" style="width:100%; margin-top:14px"></progress>
      <div id="msg" class="p" style="margin-top:8px"></div>
    </div>
  </div>
</section>

<script>
const $ = (s)=>document.querySelector(s);
$('#btn').addEventListener('click', async ()=>{
  const f = $('#file').files?.[0];
  if(!f){ $('#msg').textContent='파일을 선택하세요'; return; }
  $('#msg').textContent='사전서명 요청 중…';
  try{
    const r = await fetch('/api/presign-put', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ filename: f.name, type: f.type, size: f.size })
    });
    const { uploadUrl, publicUrl, key, error } = await r.json();
    if(!r.ok || !uploadUrl){ throw new Error(error||'presign 실패'); }

    $('#msg').textContent='S3로 업로드 중…';
    $('#bar').value=0;

    await fetch(uploadUrl, {
      method:'PUT',
      headers: { 'Content-Type': f.type },
      body: f
    }).then(async rr=>{
      if(!rr.ok){
        const t = await rr.text();
        throw new Error('S3 PUT 실패: '+t);
      }
    });

    $('#msg').textContent='완료!';
    const a = $('#link'); a.href = publicUrl; a.style.display='inline-flex';
  }catch(e){
    $('#msg').textContent='오류: '+(e?.message||e);
  }
});

// 진행률이 필요하면 XMLHttpRequest로 PUT 구현 가능(지금은 단순).
</script>
</body>
</html>